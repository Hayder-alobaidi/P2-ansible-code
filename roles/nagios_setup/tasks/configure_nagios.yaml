    - name: Add Nagios admin user
      command: htpasswd -b /etc/nagios/passwd nagiosadmin {{ password }}
      vars:
        password: 'password'


    - name: Ensure Nagios command definition for check_nrpe
      blockinfile:
        path: /etc/nagios/objects/commands.cfg
        block: |
          define command{
              command_name        check_nrpe
              command_line        $USER1$/check_nrpe -H $HOSTADDRESS$ -c $ARG1$
          }
        marker: "# {mark} ANSIBLE MANAGED BLOCK check_nrpe"

    - name: Ensure nagios.cfg includes servers directory
      lineinfile:
        path: /etc/nagios/nagios.cfg
        regexp: '^#cfg_dir=/etc/nagios/servers'
        line: 'cfg_dir=/etc/nagios/servers'
        state: present

    - name: Create configuration directory
      file:
        path: /etc/nagios/servers
        state: directory

    - name: Create Nagios configuration files
      template:
        src: nagios_template.cfg.j2
        dest: "/tmp/{{ item }}.cfg"  # Temporary location on each host
      loop: "{{ groups['all'] }}"  # Loop over all hosts in the inventory (you can also limit this to specific groups)
      loop_control:
        loop_var: item
      vars:
        ansible_host: "{{ hostvars[item].ansible_host }}"  # Ensure ansible_host is available
        web_servers: "{{ groups['web_servers'] | default([]) }}"
        database_servers: "{{ groups['database_servers'] | default([]) }}"
